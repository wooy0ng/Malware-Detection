import os
import streamlit as st
import pandas as pd
import test as prediction
from pathlib import Path
from utils import read_conf


def main():
    st.title("Prototype")
    uploaded_file = st.file_uploader("Choose a file")

    if uploaded_file is not None:
        save_path = save_uploaded_file(uploaded_file)
        save_path = Path(save_path)
        st.success(f"File successfully uploaded and saved at: {save_path}")

        # set config
        config_path = "config/test_config.yaml"
        config = read_conf(config_path)
        config.update({"file": save_path.absolute()})

        try:
            predicted = prediction.main(config)

            result = "malicious" if predicted == 1 else "benign"
            st.markdown(f"#### This file is predicted to be {result}")

        except Exception as e:
            st.error(f"Error reading the file: {e}")


def save_uploaded_file(uploaded_file):
    upload_dir = "uploads"
    os.makedirs(upload_dir, exist_ok=True)

    file_path = os.path.join(upload_dir, uploaded_file.name)
    with open(file_path, "wb") as f:
        f.write(uploaded_file.getbuffer())

    return file_path


if __name__ == "__main__":
    main()
